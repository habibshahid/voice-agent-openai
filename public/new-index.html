// Client-side code
let websocket = null;
let isRecording = false;
let clientId = null;
let audioContext = null;
let microphoneStream = null;
let audioProcessor = null;
let cart = [];

// Initialize
function initialize() {
    console.log('Initializing...');
    
    // Connect to server WebSocket
    connectToServer();
    
    // Set up UI event listeners
    document.getElementById('startButton').addEventListener('click', toggleRecording);
    document.getElementById('sendButton').addEventListener('click', sendTextMessage);
    document.getElementById('languageSelect').addEventListener('change', changeLanguage);
}

// Connect to server
function connectToServer() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}/ws`;
    
    websocket = new WebSocket(wsUrl);
    
    websocket.onopen = () => {
        console.log('Connected to server');
        updateStatus('Connected to server...');
    };
    
    websocket.onmessage = (event) => {
        const message = JSON.parse(event.data);
        handleServerMessage(message);
    };
    
    websocket.onerror = (error) => {
        console.error('WebSocket error:', error);
        updateStatus('Connection error');
    };
    
    websocket.onclose = () => {
        console.log('Disconnected from server');
        updateStatus('Disconnected. Refresh to reconnect.');
        
        // Stop recording if active
        if (isRecording) {
            stopRecording();
        }
    };
}

// Handle messages from server
function handleServerMessage(message) {
    console.log('Message from server:', message);
    
    switch (message.type) {
        case 'connection':
            // Store client ID
            clientId = message.id;
            console.log('Connected with ID:', clientId);
            
            // Initialize session with language
            initializeSession();
            break;
            
        case 'ready':
            // OpenAI connection ready
            updateStatus('Ready. Click "Start Conversation" to begin.');
            document.getElementById('startButton').disabled = false;
            break;
            
        case 'text':
            // Handle text message
            addMessageToTranscript('agent', message.data);
            break;
            
        case 'audio':
            // Handle audio message
            playAudio(message.data);
            break;
            
        case 'function_call':
            // Handle function call
            handleFunctionCall(message);
            break;
            
        case 'error':
            // Handle error
            console.error('Server error:', message.error);
            updateStatus(`Error: ${message.error.message}`);
            break;
            
        case 'disconnected':
            // Handle disconnection
            updateStatus('Connection to AI lost. Try refreshing.');
            document.getElementById('startButton').disabled = true;
            break;
    }
}

// Initialize session
function initializeSession() {
    const language = document.getElementById('languageSelect').value;
    
    websocket.send(JSON.stringify({
        type: 'init',
        language: language
    }));
    
    updateStatus('Connecting to AI...');
}

// Toggle recording
function toggleRecording() {
    if (!isRecording) {
        startRecording();
    } else {
        stopRecording();
    }
}

// Start recording
async function startRecording() {
    try {
        // Request microphone access
        microphoneStream = await navigator.mediaDevices.getUserMedia({
            audio: {
                channelCount: 1,
                sampleRate: 16000,
                echoCancellation: true,
                noiseSuppression: true,
                autoGainControl: true
            }
        });
        
        // Create audio context
        audioContext = new (window.AudioContext || window.webkitAudioContext)({
            sampleRate: 16000
        });
        
        // Create audio source
        const source = audioContext.createMediaStreamSource(microphoneStream);
        
        // Create script processor
        audioProcessor = audioContext.createScriptProcessor(4096, 1, 1);
        audioProcessor.onaudioprocess = handleAudioProcess;
        
        // Connect nodes
        source.connect(audioProcessor);
        audioProcessor.connect(audioContext.destination);
        
        // Update UI
        isRecording = true;
        document.getElementById('startButton').textContent = 'Stop Listening';
        document.getElementById('microphoneIndicator').classList.add('active');
        updateStatus('Listening...');
    } catch (error) {
        console.error('Error starting recording:', error);
        updateStatus(`Microphone error: ${error.message}`);
    }
}

// Handle audio processing
function handleAudioProcess(event) {
    if (!isRecording || !websocket || websocket.readyState !== WebSocket.OPEN) {
        return;
    }
    
    // Get audio data
    const inputBuffer = event.inputBuffer;
    const audioData = inputBuffer.getChannelData(0);
    
    // Convert to 16-bit PCM
    const pcmData = new Int16Array(audioData.length);
    for (let i = 0; i < audioData.length; i++) {
        pcmData[i] = Math.max(-1, Math.min(1, audioData[i])) * 0x7FFF;
    }
    
    // Convert to base64
    const base64Data = arrayBufferToBase64(pcmData.buffer);
    
    // Send to server
    websocket.send(JSON.stringify({
        type: 'audio',
        data: base64Data
    }));
}

// Convert ArrayBuffer to Base64
function arrayBufferToBase64(buffer) {
    const bytes = new Uint8Array(buffer);
    let binary = '';
    for (let i = 0; i < bytes.byteLength; i++) {
        binary += String.fromCharCode(bytes[i]);
    }
    return btoa(binary);
}

// Stop recording
function stopRecording() {
    // Stop microphone
    if (microphoneStream) {
        microphoneStream.getTracks().forEach(track => track.stop());
        microphoneStream = null;
    }
    
    // Disconnect audio processor
    if (audioProcessor) {
        audioProcessor.disconnect();
        audioProcessor = null;
    }
    
    // Update UI
    isRecording = false;
    document.getElementById('startButton').textContent = 'Start Conversation';
    document.getElementById('microphoneIndicator').classList.remove('active');
    updateStatus('Paused. Click "Start Conversation" to continue.');
}

// Send text message
function sendTextMessage() {
    const text = document.getElementById('textInput').value.trim();
    if (!text) return;
    
    // Add to transcript
    addMessageToTranscript('user', text);
    
    // Send to server
    websocket.send(JSON.stringify({
        type: 'text',
        text: text
    }));
    
    // Clear input
    document.getElementById('textInput').value = '';
}

// Change language
function changeLanguage() {
    const language = document.getElementById('languageSelect').value;
    
    // Re-initialize session with new language
    initializeSession();
}

// Handle function calls
function handleFunctionCall(functionCall) {
    const functionName = functionCall.name;
    const functionArgs = functionCall.arguments;
    const functionId = functionCall.id;
    
    console.log(`Function call: ${functionName}`, functionArgs);
    
    let result = null;
    
    // Process function based on name
    switch (functionName) {
        case 'add_to_cart':
            result = handleAddToCart(functionArgs);
            break;
            
        case 'modify_cart_item':
            result = handleModifyCartItem(functionArgs);
            break;
            
        case 'remove_from_cart':
            result = handleRemoveFromCart(functionArgs);
            break;
            
        case 'clear_cart':
            result = handleClearCart();
            break;
            
        case 'checkout':
            result = handleCheckout(functionArgs);
            break;
            
        default:
            console.warn('Unknown function:', functionName);
            result = { error: 'Unknown function' };
    }
    
    // Send function result back to server
    websocket.send(JSON.stringify({
        type: 'function_result',
        id: functionId,
        name: functionName,
        result: result
    }));
}

// Function handlers (same as your existing code)
function handleAddToCartAction(action) {
    debugLog('Adding to cart:', action);
    
    // Find the menu item in our data
    const item = findMenuItem(action.item, window.restaurantData);
    
    if (!item) {
        console.error('Item not found:', action.item);
        return { success: false, error: `Item "${action.item}" not found` };
    }
    
    // Create the cart item
    const cartItem = {
        id: action.id || item.id || `item_${Date.now()}`,
        name: item.name,
        price: item.price,
        description: item.description,
        quantity: action.quantity || 1,
        size: action.size || null,
        customizations: action.customizations || []
    };
    
    // Calculate the total price
    cartItem.totalPrice = calculateItemPrice(cartItem);
    
    // Add to cart
    addToCart(cartItem);
    
    // Show visual confirmation
    showOrderConfirmation(cartItem);
    
    // Return success result
    return { 
        success: true, 
        item: {
            id: cartItem.id,
            name: cartItem.name,
            price: cartItem.price,
            quantity: cartItem.quantity,
            size: cartItem.size,
            customizations: cartItem.customizations,
            totalPrice: cartItem.totalPrice
        }
    };
}

// Handle modify cart item action
function handleModifyCartItemAction(action) {
    debugLog('Modifying cart item:', action);
    
    if (!action.item) {
        console.error('No item specified for modification');
        return { success: false, error: 'No item specified for modification' };
    }
    
    // Find the item in the cart by name
    const itemIndex = cart.findIndex(item => 
        item.name && item.name.toLowerCase() === action.item.toLowerCase());
    
    if (itemIndex === -1) {
        console.error('Item not found in cart:', action.item);
        return { success: false, error: `Item "${action.item}" not found in cart` };
    }
    
    const cartItem = cart[itemIndex];
    const oldTotalPrice = cartItem.totalPrice;
    
    // Apply changes
    if (action.quantity !== undefined) {
        cartItem.quantity = action.quantity;
    }
    
    if (action.size !== undefined) {
        cartItem.size = action.size;
    }
    
    if (action.customizations !== undefined) {
        cartItem.customizations = action.customizations;
    }
    
    // Recalculate price
    cartItem.totalPrice = calculateItemPrice(cartItem);
    
    // Update total price
    totalPrice = totalPrice - oldTotalPrice + cartItem.totalPrice;
    
    // Update cart UI
    updateCartUI();
    
    // Show confirmation
    showModificationConfirmation(cartItem);
    
    // Return success result
    return { 
        success: true, 
        item: {
            id: cartItem.id,
            name: cartItem.name,
            totalPrice: cartItem.totalPrice
        }
    };
}

// Handle remove from cart action
function handleRemoveFromCartAction(action) {
    debugLog('Removing from cart:', action);
    
    if (!action.item) {
        console.error('No item specified for removal');
        return { success: false, error: 'No item specified for removal' };
    }
    
    // Find the item in the cart by name
    const itemIndex = cart.findIndex(item => 
        item.name && item.name.toLowerCase() === action.item.toLowerCase());
    
    if (itemIndex === -1) {
        console.error('Item not found in cart:', action.item);
        return { success: false, error: `Item "${action.item}" not found in cart` };
    }
    
    const cartItem = cart[itemIndex];
    
    // Remove from cart
    removeFromCart(cartItem.id);
    
    // Show confirmation
    showRemovalConfirmation(cartItem);
    
    // Return success result
    return { 
        success: true, 
        item: {
            name: cartItem.name,
            id: cartItem.id
        }
    };
}

// Handle clear cart action
function handleClearCartAction() {
    debugLog('Clearing cart');
    
    // Get cart size before clearing
    const itemCount = cart.length;
    
    // Clear the cart
    cart = [];
    totalPrice = 0;
    updateCartUI();
    
    // Show confirmation
    showClearCartConfirmation();
    
    // Return success result
    return { 
        success: true, 
        itemsRemoved: itemCount
    };
}

// Handle checkout action
function handleCheckoutAction(action) {
    debugLog('Starting checkout:', action);
    
    // Show checkout form with provided info
    const delivery = action.delivery !== undefined ? action.delivery : true;
    const address = action.address || '';
    const phone = action.phone || '';
    
    showCheckoutForm(delivery, address, phone);
    
    // Return success result
    return { success: true };
}

// UI helpers
function addMessageToTranscript(speaker, text) {
    const transcript = document.getElementById('transcript');
    const messageElement = document.createElement('div');
    messageElement.classList.add('transcript-message', `${speaker}-message`);
    messageElement.textContent = text;
    transcript.appendChild(messageElement);
    transcript.scrollTop = transcript.scrollHeight;
}

function updateStatus(message) {
    document.getElementById('status').textContent = message;
}

function playAudio(base64Data) {
    // Decode base64 audio data
    const binaryString = atob(base64Data);
    const len = binaryString.length;
    const bytes = new Uint8Array(len);
    for (let i = 0; i < len; i++) {
        bytes[i] = binaryString.charCodeAt(i);
    }
    
    // Create audio context
    const context = new (window.AudioContext || window.webkitAudioContext)();
    
    // Decode audio data
    context.decodeAudioData(bytes.buffer, (buffer) => {
        // Create source node
        const source = context.createBufferSource();
        source.buffer = buffer;
        
        // Connect to output
        source.connect(context.destination);
        
        // Play audio
        source.start(0);
    });
}

// Initialize on page load
window.addEventListener('load', initialize);